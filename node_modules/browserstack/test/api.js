"use strict";

var should = require("should");
var BrowserStack = require("../lib/browserstack");
var util = require("./util");

var username = util.browserStack.username;
var password = util.browserStack.password;

if (!username || !password) {
	throw new Error("Please set BROWSERSTACK_USERNAME and BROWSERSTACK_KEY environment variables.");
}

describe("BrowserStack API", function() {
	this.timeout(60000); // 60s

	var client;
	var workers = [];

	beforeEach(function() {
		client = BrowserStack.createClient({
			username: username,
			password: password
		});
	});

	afterEach(function(done) {
		util.terminateWorkers(client, workers, function() {
			workers = [];
			done();
		});
	});

	describe("API Status", function() {
		it("should get API status", function(done) {
			client.getApiStatus(function(err, status) {
				should.ifError(err);

				status.should.be.an.Object().and.have.keys([
					"running_sessions",
					"sessions_limit",
					"used_time",
					"total_available_time"
				]);

				done(err);
			});
		});
	});

	describe("Browser Listing", function() {
		it("should list browsers", function(done) {
			client.getBrowsers(function(err, browsers) {
				should.ifError(err);

				browsers.should.be.an.Array().and.not.be.empty();
				browsers.map(util.validateBrowserObject);

				done(err);
			});
		});

		it("should get latest browser versions", function(done) {
			client.getLatest(function(err, versions) {
				should.ifError(err);

				versions.should.be.an.Object().and.not.be.empty();
				done(err);
			});
		});

		it("should get the latest version for specified browser", function(done) {
			client.getBrowsers(function(err, browsers) {
				should.ifError(err);

				browsers = browsers.filter(function(browser) {
					return !browser.device;
				});

				var requests = browsers.length;

				browsers.forEach(function(browser) {
					client.getLatest(browser, function(err, version) {
						should.ifError(err);
						version.should.match(/\d+(\.)*\d*/);

						if (err || --requests < 1) {
							if (done) {
								done(err);
								done = null;
							}
						}
					});
				});
			});
		});

		it("should fail to get the latest version for invalid browser", function(done) {
			client.getLatest({
				os: "Windows",
				os_version: "10",
				browser: "mosaic"
			}, function(err, version) {
				should.ifError(err);
				should.equal(undefined, version);

				done(err);
			});
		});
	});

	describe("Worker API", function() {
		var sampleDesktopBrowser = {
			os: "Windows",
			os_version: "10",
			browser: "chrome",
			browser_version: "47.0",
			timeout: 20
		};

		var sampleDeviceBrowser = {
			device: "Google Nexus 6",
			os: "android",
			os_version: "5.0",
			browser: "Android Browser",
			timeout: 20
		};

		it("should create worker", function(done) {
			client.createWorker(util.merge(sampleDesktopBrowser, {
				url: "http://www.example.com"
			}), function(err, worker) {
				should.ifError(err);

				util.validateWorker(worker);
				workers.push(worker);
				done(err);
			});
		});

		it("should create worker with latest edge", function(done) {
			client.createWorker({
				os: "Windows",
				os_version: "10",
				browser: "Edge",
				browser_version: "latest",
				url: "http://www.example.com",
				timeout: 20
			}, function(err, worker) {
				should.ifError(err);

				util.validateWorker(worker);
				workers.push(worker);
				done(err);
			});
		});

		it("should fail to create worker for invalid browser", function(done) {
			client.createWorker(util.merge(sampleDesktopBrowser, {
				url: "http://www.example.com",
				browser: "mosaic"
			}), function(err, worker) {
				err.should.be.an.Error();
				err.message.should.match(/validation failed/i);

				should.not.exist(worker);
				done();
			});
		});

		it("should create a worker with details", function(done) {
			client.createWorker(util.merge(sampleDesktopBrowser, {
				url: "http://www.example.com",
				name: "worker-1",
				build: "build-1",
				project: "project-1"
			}), function(err, worker) {
				should.ifError(err);

				util.validateWorker(worker);
				wo